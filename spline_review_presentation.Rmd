---
title: "Three Levels of Spline Models: "
subtitle: 'Understanding, Application and Beyond'
author: "Boyi Guo"
institute: |
  | Department of Biostatistics
  | University of Alabama at Birmingham
date: "April 8th, 2021"
output: 
  beamer_presentation:
    theme: "Szeged"
    colortheme: "spruce"
    toc: FALSE
    number_section: false
    slide_level: 2
header-includes:
  - \usepackage{bm}
bibliography:
  - bibliography.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(viridis)
```

# Who Am I?

 - 4th-year Ph.D. student in BST @ UAB
 
 - Dissertation: Bayesian high-dimensional additive model
 
 - Background:
 
    - B.S. in Computer Science & Stat @ UIUC    
    
    - M.S. in Statistics (Analytic track) @ UIUC    
    
    - Experienced R programmer (8-year)
    
    - "Ridiculously awesome" commented by a REGARDS collaborator

<!-- Enough commercial and self promotion, lets get to the topic-->

# Overview
* Understanding
  * Explanation & Demonstration
  * Implementation in Linear Regression
  * Implementation in Generalized Linear Models
    

* Application
  * Varying Coefficient Model
  * Survival Models
  * Smoothing Spline

  
* Beyond
  * Mixed Model (Spatial & Temporal)
  * Function Selection in High Dimension
  * Others


# Objectives
* To review the basic concepts of spline

* To raise you awareness of other advanced spline applications 

* We don't focus on model fitting algorithm or software implementation

* All the model can be implemented in R. Not sure about other softwares.

<!-- primarily R user, Hence, less familiar of spline implementation in other softwares -->

# Spline

## Motivation
> "It is extremely unlikely that the true function f(X) is actually linear in X."

\hspace*{2cm}

> --- @hastie2009elements PP. 139

<!-- For example, the relationship between age and COVID mortality. -->

## Previous Solutions:

* Variable categorization: e.g. using quartiles of a continuous variable in a model

  * Assuming all subjects within a group shares the same risk/effect
  * Different magnitude of effects around thresholds
  
  
* Polynomial regression:
  $$
  y = \beta_0 + \beta_1x + \beta_2 x^2 + \dots + \beta_mx^m + \epsilon
  $$
  * Precision issues, e.g. $x$ is blood pressure measure, and $x^3$ would be extremely large
  * Goodness of fit: deciding which order of polynomial term should be included

## Spline
* A spline is a piece-wise function where each piece is a polynomial function of order $m$

* A.K.A. non-parametric regression, semi-parametric regression, (generalized) additive model

<!-- buzz word for grant writing. Little niche here, semi-parametric and non-parametric regression could be a little broader concept. -->
* Can be easily incorporated in linear regression, generalized linear regression, Cox regression, as _regression spline_

## Spline Components

* Order/degree of the polynomial function, $m$

  * Normally, $m=3$ is sufficient

* An increasing breakpoints sequence $\tau$
  * A.K.A. knots
  * $|\tau| = 5$, equally spaced

*  the continuity conditions at knots, $v$
  * Continuous at second derivative for natural cubic spline


## Spline Example

A spline of order 0 with 2 knots

\begin{equation*}
  f(x) = 
  \begin{cases}
  2, & x \leq 1 \\
  1.2, & 1 < x \leq 5\\
  1.5, & x > 5
  \end{cases}
\end{equation*}
  <!-- This is the business of column space force, aka linear algebra mathematicians. -->

## Visual Demonstration

![](Figure/linear_spline.jpg)

Figure from @hastie2009elements PP.142

## Cubic Spline
* Cubic polynomial in each piece-wise function, i.e. m = 3

  * E.g. truncated power bases with 3 knots at $\tau_1, \tau_2, \tau_3$
\begin{align*}
f(x) &= \beta_0 + \beta_1 x+\beta_2 x^2 + \beta_3 x^3 + \beta_4(x-\tau_1)^3_+\\
& +  \beta_5(x-\tau_2)^3_+ + \beta_6(x-\tau_3)^3_+\\
&= \bm \beta^T \bm B(x)
\end{align*}


* Continuous at second derivative

  * The smoothest possible interpolant
  
* Alternative representation
  * Natural cubic spline for linearity beyond boundary knots ($f^{'''}(x) = 0$)
  * B-spline basis for stable computation
  

  
## Cubic Spline
![](Figure/cubic_spline.jpg){height=75%}

Figure from @hastie2009elements PP.143

## Implementation

Given the matrix form of the spline function $f(x) = \bm \beta \bm B(x)$,

* Linear regression: 
$$y_i \sim N(\bm \beta \bm B(x_i) + \bm \beta^\prime \bm Z_i, \sigma^2)$$
* Generalized linear regression: 
$$E(y_i) = g^{-1}(\bm \beta \bm B(x_i) + \bm \beta^\prime \bm Z_i), Y_i \sim EF$$
* Cox regression:
$$h(t_i) = h_0(t_i) exp(\bm \beta \bm B(x_i) + \bm \beta^\prime \bm Z_i)$$

* Model fitting and diagnositc remain the same

## Software Implementation
Two-step procedure

* Create the 'design' matrix of the spline function $B(x)$
* Fit the preferred model including $B(x)$ as covariates / predictors

```{r eval=FALSE}
library(splines)  # Package for b-spline

x_spline <- bs(x, degree = 3, # cubic polynomial
               df = 8)   # 5 (df-degree) knots         
glm(y ~ x_spline) # Fitting the spline model

# Equivalently
glm(y ~ bs(x, degree=3, df=8))
```

## Variability Band

* A delicate statistical problem

* Most commonly used: point-wise 95% confidence interval

* Can be calculate using statistical contrasts

## Hypothesis Testing

* Two hypothesis tests

  * If the non-linear terms are necessary:
  $$
    H_0: \beta_2 = \beta_3 = \dots = 0
  $$
  * If the variable is necessary in the model
  $$
    H_0: f(x) = 0
  $$

* Be careful when reading program manual




# Application

## Varying Coefficient Model
* The effect of a variable $Z$ on the outcome $y$ are different at different values of some other variable $X$
* Specifically, the slope of the effect are not constant across the domain of $X$

```{r echo=F}

dat <- data.frame(
  X = rep(seq(1, 3, length.out=100), 2),
  Z = c(rep(0,100),rep(1,100)) %>% factor
) %>% 
  mutate(
    y_ln = 1+0.3*(as.numeric(Z)-1)  + 0.5*X*(as.numeric(Z)-1),
    y_sp = 1+0.3*(as.numeric(Z)-1)  + 0.5*X*(as.numeric(Z)-1) + 0.3*sin(10*X)*(as.numeric(Z)-1)
  )


ggarrange(
  ggplot(dat) +
    geom_line(aes(x = X, y=y_ln, color = Z, group = Z), size = 1)+
    ylim(0,3)+
    theme_pubclean() +
    scale_color_viridis(discrete=TRUE, option = "D"),
  ggplot(dat) +
    geom_line(aes(x = X, y=y_sp, color = Z, group = Z), size = 1)+
    ylim(0,3)+
    scale_color_viridis(discrete=TRUE, option = "D")+
          theme_pubclean(),
  common.legend = TRUE,
  legend = "bottom"
)

```

## Modelling Effect Modification

$$
E(y) = f(X) + f^\prime(X)Z = \beta_{Z=0} B(X) + \beta_{Z=1}B(X)*Z
$$

* $f(x)$ models the effect of $X$ when $Z=0$
* $f^\prime(X)Z$ models the modifying effect of $Z$ at different values of $X$
* $f^\prime(X)$ is the varying coefficient of $Z$, using a non-linear function, for non-constant slope.
* Assumptions of consideration
  * Should $f(x)$ be linear or non-linear?
  * Should $f(x)$ use the same bases as $f^\prime(X)$?
  * Should $f(x)$ be the same level of complexity as  $f^\prime(X)$?


## Survival Models
  * Defer to Sleeper and Harrington(1990) for non-linear hazard
      * Knots are decided by equal number of failure in each group
      * Transform the variable when extreme value exists
      * Examine outlier effect on non-linear tests
      
## Non-proportional Hazards
* Cox PH model assumes proportional hazards, i.e. the hazard/effect of a variable $Z$ is independent to time

* Using Time-varying coefficients to model the non-proportional hazards

$$
  h(t) = h_0(t)exp(f(t)X) 
$$
* Defer to Gray (1992) and references therein
    
## Smoothing Spline
* Motivation: 
   * To simplify the decision making about the knots

* Idea: 
  * Set the number of knots to a really large value (k=25, 40, $N$)
  * Use variable selection methods, penalized models specifically, to decide the smoothness of the spline

  
## Statistical Complications
  * Estimated degree of freedom due to shrinkage
    * Harder to conduct hypothesis testing, and calculate CI
    
  * More decisions when modeling effect modification
    * Same smoothness for the spline functions?
    * If the same, how to estimate the smoothness
  
# Beyond

## Spline Surface

* Model the non-linear interaction between two continuous variables

* Thin-plate splines, tensor product splines
  * Thin-plate spline is scale-sensitive
    * Recommended when variables are on the same scale
  * Tensor product spline is scale-invariant

* Dealing boundary effect
  * Soap film smoothing

* Application: 
  * Loop, M. S., Howard, G., de Los Campos, G., Al-Hamdan, M. Z., Safford, M. M., Levitan, E. B., & McClure, L. A. (2017). Heat maps of hypertension, diabetes mellitus, and smoking in the continental United States. __Circulation: Cardiovascular Quality and Outcomes, 10(1), e003350.__

## Mixed Model

## Function Selection


# Conclusion
* Reviewed concepts of spline

* New insight of advanced spline models

* __Consult with statisticians when feeling not comfortable doing spline models__


# Q & A